<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University Course Selector</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for better look */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #a0aec0; /* Tailwind gray-400 */
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background-color: #f7fafc; /* Tailwind gray-50 */
        }
        /* Specificity for horizontal scrollbar */
        .overflow-x-auto.custom-scroll::-webkit-scrollbar {
            height: 10px;
        }

        .section-card {
            transition: all 0.2s ease;
        }
        .section-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .conflict {
            border-color: #f56565 !important; /* Tailwind red-500 */
            background-color: #fed7d7 !important; /* Tailwind red-200 */
        }
        .selected {
            border-color: #48bb78 !important; /* Tailwind green-500 */
            background-color: #c6f6d5 !important; /* Tailwind green-200 */
        }
        .course-selected {
            background-color: #d1e5ff !important; /* Tailwind blue-100 */
            border-color: #4299e1 !important; /* Tailwind blue-500 */
        }
        /* Ensure the main container for courses to assign has enough height on small screens */
        @media (max-width: 1023px) {
            #assignment-course-list {
                max-height: 150px;
                flex-wrap: wrap;
                overflow-y: auto;
                overflow-x: hidden;
                gap: 0.75rem; /* Gap for wrapped items */
                padding-bottom: 0;
            }
            .w-40 {
                width: calc(50% - 0.75rem); /* Adjust width for 2-column wrapping on mobile */
                flex-shrink: 0;
            }
        }
        
        /* --- NEW: Modal Styles --- */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: all 0.3s ease;
        }
        
        /* --- NEW: Calendar Grid Styles (Compact) --- */
        .calendar-grid {
            display: grid;
            grid-template-columns: 60px repeat(4, 1fr); /* Time + Sat, Sun, Tue, Wed */
            grid-template-rows: auto; /* Header row */
            border-left: 1px solid #e2e8f0; /* gray-200 */
            border-top: 1px solid #e2e8f0;
        }
        .calendar-grid > div {
            border-right: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            padding: 1px 4px; /* Compact padding */
        }
        .calendar-header {
            background-color: #f7fafc; /* gray-50 */
            font-weight: 600;
            text-align: center;
            padding: 4px 4px !important; /* Compact padding */
            font-size: 0.875rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .calendar-time-cell {
            font-size: 0.625rem; /* 10px */
            font-weight: 500;
            text-align: right;
            padding: 1px 4px !important; /* Compact padding */
            color: #4a5568; /* gray-600 */
        }
        .calendar-class-cell {
            grid-column-start: var(--col-start);
            grid-row: var(--row-start) / var(--row-end);
            background-color: #ebf4ff; /* blue-100 */
            border: 1px solid #90cdf4; /* blue-300 */
            border-radius: 4px;
            margin: 1px;
            overflow: hidden;
            font-size: 0.625rem; /* 10px */
            line-height: 1.1; /* Compact line height */
            z-index: 5;
        }
        .calendar-class-cell strong {
            font-weight: 600;
            color: #2c5282; /* blue-800 */
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen font-sans antialiased p-4 sm:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">University Course Scheduler</h1>
            <p class="text-gray-600">Plan your semester schedule with ease.</p>
        </header>

        <!-- Dynamic View Container -->
        <div id="app-container">
            <!-- Loading indicator initially, then content -->
            <div id="loading-indicator" class="text-center py-20">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                <p class="text-gray-700 font-semibold">Loading course data...</p>
            </div>
        </div>
    </div>

    <!-- --- NEW: Routine Modal Structure (Initially Hidden) --- -->
    <div id="routine-modal" class="modal-overlay fixed inset-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center p-4 z-40 hidden">
        <div class="modal-content bg-white w-full max-w-4xl max-h-[90vh] rounded-xl shadow-2xl relative overflow-hidden flex flex-col">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-2xl font-bold text-gray-800">Weekly Routine</h2>
                <button id="modal-close-btn" class="modal-close-btn text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
            </div>
            <!-- Modal Body (Scrollable) -->
            <div class="p-4 md:p-6 overflow-y-auto">
                <div id="calendar-grid-container" class="calendar-grid">
                    <!-- Calendar will be rendered here by JS -->
                </div>
            </div>
            <!-- *** NEW: Modal Footer for Export Button *** -->
            <div class="p-4 border-t bg-gray-50 text-right">
                <button id="export-ics-btn" class="py-2 px-4 rounded-lg bg-green-600 text-white font-semibold hover:bg-green-700 transition duration-150 text-sm">
                    Export to .ICS
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        // Global variables for data management
        let allCoursesData = []; // All rows from the CSV
        let uniqueCourses = []; // List of unique courses (Formal Code + Title)
        let uniquePrograms = []; // List of unique programs for filtering (View 1)
        
        let selectedCoursesForAssignment = new Set(); // Course keys selected in View 1
        let selectedSections = {}; // {courseKey: sectionData} - Selections made in View 2

        let viewState = 'courseSelection'; // 'courseSelection' or 'sectionAssignment'
        let currentView2CourseKey = null; // Key of the course currently displayed in the Section list panel
        let currentFilters = { faculty: [], time: [], day: [] }; // Stores multi-select filter state for View 2

        // --- Time Slot Configuration ---
        const THEORY_SLOTS = [
            "08:30:AM - 09:50:AM",
            "09:51:AM - 11:10:AM",
            "11:11:AM - 12:30:PM",
            "12:31:PM - 01:50:PM",
            "01:51:PM - 03:10:PM",
            "03:11:PM - 04:30:PM"
        ];

        const LAB_SLOTS = [
            "08:30:AM - 11:00:AM",
            "11:11:AM - 01:40:PM",
            "02:00:PM - 04:30:PM"
        ];
        
        // --- Day Configuration ---
        const THEORY_DAYS = [
            "Sat/Tue",
            "Sun/Wed"
        ];
        
        const LAB_DAYS = [
            "Sat",
            "Sun",
            "Tue",
            "Wed"
        ];
        
        // Combine and unique time slots for filter generation
        const ALL_UNIQUE_TIME_SLOTS = [...new Set([...THEORY_SLOTS, ...LAB_SLOTS])].sort();

        // --- Utility Functions for Time & Conflict Checking (Unchanged) ---

        /** Parses time string into minutes from midnight. */
        function timeToMinutes(timeStr) {
            if (!timeStr) return -1;
            const parts = timeStr.match(/(\d+):(\d+):([AP]M)/i);
            if (!parts) return -1;

            let hour = parseInt(parts[1], 10);
            const minute = parseInt(parts[2], 10);
            const ampm = parts[3].toUpperCase();

            if (ampm === 'PM' && hour !== 12) {
                hour += 12;
            } else if (ampm === 'AM' && hour === 12) {
                hour = 0; // 12:XX AM is 0 hour
            }

            return (hour * 60) + minute;
        }

        /** Parses a time slot string (e.g., "08:30:AM - 09:50:AM") into start and end minutes. */
        function parseTimeRange(timeSlot) {
            if (!timeSlot || timeSlot.trim() === '-') return { start: -1, end: -1 };
            const [startTimeStr, endTimeStr] = timeSlot.split(' - ').map(s => s.trim());
            return {
                start: timeToMinutes(startTimeStr),
                end: timeToMinutes(endTimeStr)
            };
        }

        /** Checks if two time intervals on the same day overlap. */
        function checkOverlap(startA, endA, startB, endB) {
            return startA < endB && endA > startB;
        }

        /** Converts a Time slot string into a schedule object. */
        function parseScheduleSlot(day, timeSlot) {
            const { start, end } = parseTimeRange(timeSlot);
            if (start === -1 || end === -1 || !day) return [];

            return [{ day, start, end }];
        }

        /** Gets all schedule slots for a given section data row. */
        function getSectionSchedule(sectionData) {
            let schedule = [];
            schedule = schedule.concat(parseScheduleSlot(sectionData['Day1'], sectionData['Time1']));
            schedule = schedule.concat(parseScheduleSlot(sectionData['Day2'], sectionData['Time2']));
            return schedule;
        }

        /**
         * Checks if adding a new section conflicts with any existing selected section.
         */
        function findConflict(newSectionData, currentSelections) {
            const newSchedule = getSectionSchedule(newSectionData);
            const newCourseKey = getCourseKey(newSectionData);

            for (const key in currentSelections) {
                const existingSectionData = currentSelections[key];
                // Crucial: Skip checking against a selection from the *same* course (since it's a replacement)
                if (key === newCourseKey) continue;

                const existingSchedule = getSectionSchedule(existingSectionData);

                for (const newSlot of newSchedule) {
                    for (const existingSlot of existingSchedule) {
                        if (newSlot.day === existingSlot.day) {
                            if (checkOverlap(newSlot.start, newSlot.end, existingSlot.start, existingSlot.end)) {
                                return existingSectionData; // Found a conflict
                            }
                        }
                    }
                }
            }
            return null; // No conflict found
        }

        /** Converts minutes (e.g., 510) back to HH:MM:AM/PM (e.g., 08:30:AM) for comparison. */
        function timeSlotToString(minutes) {
            if (minutes === -1) return '';
            const totalMinutes = minutes % (24 * 60);
            let hours = Math.floor(totalMinutes / 60);
            const mins = totalMinutes % 60;
            const ampm = hours >= 12 ? 'PM' : 'AM';

            if (hours > 12) hours -= 12;
            if (hours === 0) hours = 12; // Midnight case

            const hourStr = String(hours).padStart(2, '0');
            const minStr = String(mins).padStart(2, '0');
            
            return `${hourStr}:${minStr}:${ampm}`;
        }


        // --- Core Data & Rendering Functions ---

        /** Parses CSV text into an array of objects. */
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length === 0) return [];

            // Updated split to handle commas inside quotes later if needed, 
            // but for this simple data structure, a direct split works
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                // Handle the case of empty faculty names which results in fewer columns
                if (values.length < headers.length - 2) continue; 
                
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || ''; // Use empty string for missing values
                });
                data.push(row);
            }
            return data;
        }

        /** Creates a unique key for a course based on its code and title. */
        function getCourseKey(courseData) {
            return `${courseData['Formal Code']}_${courseData['Title']}`;
        }
        
        /** Fetches course data from the CSV file and initializes the application. */
        async function initializeData() {
            try {
                // Fetch the CSV file from the same directory
                const response = await fetch('course_offerings.csv');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                // --- END INLINED CSV DATA ---

                allCoursesData = parseCSV(csvText);

                if (allCoursesData.length === 0) {
                    document.getElementById('app-container').innerHTML = '<div class="p-10 text-center bg-red-100 border border-red-400 text-red-700 rounded-xl">Error: Could not load or parse course data. The CSV data might be empty or missing headers.</div>';
                    return;
                }

                const uniqueCourseMap = new Map();
                const programSet = new Set();
                programSet.add('All Programs');

                allCoursesData.forEach(row => {
                    const key = getCourseKey(row);
                    // Store one representative row for the course
                    if (!uniqueCourseMap.has(key)) {
                        uniqueCourseMap.set(key, {
                            'Formal Code': row['Formal Code'],
                            'Title': row['Title'],
                            'Program': row['Program'],
                            'Cr.': row['Cr.'],
                            key: key
                        });
                        programSet.add(row['Program']);
                    }
                });

                uniqueCourses = Array.from(uniqueCourseMap.values());
                uniquePrograms = Array.from(programSet).sort();

                // Start rendering the app after data is loaded and processed
                renderApp();

            } catch (error) {
                console.error("Failed to process course data:", error);
                document.getElementById('app-container').innerHTML = `<div class="p-10 text-center bg-red-100 border border-red-400 text-red-700 rounded-xl">Error processing data: ${error.message}.</div>`;
            }
        }


        // --- View Management ---

        /** Renders the entire application based on the current viewState. */
        function renderApp() {
            const container = document.getElementById('app-container');
            container.innerHTML = ''; // Clear previous view (including loading indicator)

            if (viewState === 'courseSelection') {
                container.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- 1. Course Selection Panel (Phase 1) -->
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg h-full overflow-hidden">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">1. Select Courses for Assignment</h2>

                            <!-- Filtering and Search Controls -->
                            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                                <input type="text" id="course-search" placeholder="Search by Code or Title..."
                                    oninput="filterAndRenderCourses()"
                                    class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">

                                <select type="text" id="program-filter" onchange="filterAndRenderCourses()"
                                    class="p-2 border border-gray-300 rounded-lg bg-white focus:ring-indigo-500 focus:border-indigo-500">
                                    <!-- Options populated by JS -->
                                </select>
                            </div>

                            <div id="course-list-selection" class="space-y-3 h-[60vh] lg:h-[70vh] custom-scroll overflow-y-auto pr-2">
                                <!-- Filtered course cards will be rendered here -->
                            </div>
                        </div>

                        <!-- 2. Action Panel (Phase 1 Right) -->
                        <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-full">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Selected Courses</h2>
                            <div id="pre-selected-summary" class="space-y-3 h-[60vh] lg:h-[70vh] custom-scroll overflow-y-auto pr-2 mb-4">
                                <p class="text-center text-gray-500">No courses selected yet.</p>
                            </div>

                            <button onclick="changeView('sectionAssignment')"
                                class="w-full py-3 px-4 rounded-xl bg-indigo-600 text-white font-semibold shadow-md hover:bg-indigo-700 transition duration-150 disabled:bg-gray-400"
                                id="go-to-assignment-btn" disabled>
                                Go to Section Assignment (0)
                            </button>
                        </div>
                    </div>
                `;
                populateProgramFilter();
                filterAndRenderCourses();

            } else if (viewState === 'sectionAssignment') {
                container.innerHTML = `
                    <div class="flex justify-start mb-6">
                        <button onclick="changeView('courseSelection')"
                            class="py-2 px-4 rounded-lg bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition duration-150 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                            Back to Course Selection
                        </button>
                    </div>

                    <!-- 1. Assigned Courses List (Top, Full Width, Horizontal Scrollable) -->
                    <div class="bg-white p-4 rounded-xl shadow-lg mb-8 overflow-hidden">
                        <h2 class="text-xl font-bold text-gray-800 mb-3 border-b pb-2">1. Courses to Assign (Select a course to view sections)</h2>
                        <div id="assignment-course-list" class="flex space-x-4 pb-2 custom-scroll overflow-x-auto">
                            <!-- Horizontal course buttons will be rendered here -->
                        </div>
                    </div>

                    <!-- Main Assignment Layout Grid (2 Columns below: 2/3 and 1/3 split) -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        
                        <!-- 2. Section Details Panel (Center, takes 2/3 space) -->
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg h-full overflow-hidden">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">2. Available Sections</h2>
                            <div id="selected-course-info" class="mb-4 text-gray-700 font-semibold">
                                Select a course above to view sections.
                            </div>

                            <!-- *** COLLAPSIBLE FILTER CONTROL (Corrected) *** -->
                            <div id="section-filters-wrapper" class="mb-4 p-3 bg-gray-50 rounded-xl border border-gray-200">
                                
                                <!-- TOGGLE BUTTON (Clickable area) -->
                                <div id="filterToggle" class="flex items-center justify-between cursor-pointer">
                                    <p class="font-semibold text-sm text-gray-700 mb-2">Filter Sections:</p>
                                    <!-- Arrow Icon (Starts closed) -->
                                    <span id="arrowIcon" class="text-lg transform rotate-0 transition-transform duration-300 ml-2">â–¶</span>
                                </div>
                                
                                <!-- CONTENT TO HIDE/SHOW (Initially Hidden) -->
                                <div id="filterContent" class="grid grid-cols-1 md:grid-cols-3 gap-4 hidden">
                                    
                                    <!-- Faculty Filter -->
                                    <div class="p-2 border border-gray-300 rounded-lg bg-white">
                                        <label class="block text-xs font-semibold text-gray-600 mb-1">Faculty Filter (Multi-Select)</label>
                                        <div id="faculty-filter-container" class="max-h-24 overflow-y-auto space-y-1">
                                            <!-- Faculty checkboxes will be rendered here -->
                                        </div>
                                    </div>
                                    
                                    <!-- Time Slot Filter -->
                                    <div class="p-2 border border-gray-300 rounded-lg bg-white">
                                        <label class="block text-xs font-semibold text-gray-600 mb-1">Time Slot Filter (Multi-Select)</label>
                                        <div id="time-filter-container" class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto">
                                            <!-- Time Slot checkboxes will be rendered here -->
                                        </div>
                                    </div>
                                    
                                    <!-- *** NEW: Day Filter *** -->
                                    <div class="p-2 border border-gray-300 rounded-lg bg-white">
                                        <label class="block text-xs font-semibold text-gray-600 mb-1">Day Filter (Multi-Select)</label>
                                        <div id="day-filter-container" class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto">
                                            <!-- Day checkboxes will be rendered here -->
                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                            <!-- END Filtering Controls -->

                            <div id="section-list" class="space-y-4 h-[40vh] md:h-[50vh] custom-scroll overflow-y-auto pr-2">
                                <!-- Section cards will be rendered here -->
                            </div>
                        </div>

                        <!-- 3. Current Schedule Panel (Right, takes 1/3 space) -->
                        <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-full overflow-hidden">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center justify-between">
                                3. My Schedule
                                <span id="total-credits" class="text-sm font-normal bg-blue-100 text-blue-800 px-3 py-1 rounded-full">Credits: 0</span>
                            </h2>
                            <button id="view-routine-btn" class="w-full py-2 px-4 rounded-xl bg-blue-600 text-white font-semibold shadow-md hover:bg-blue-700 transition duration-150 disabled:bg-gray-400 mb-4" disabled>
                                View Routine
                            </button>
                            <div id="schedule-summary" class="space-y-4 h-[60vh] md:h-[65vh] custom-scroll overflow-y-auto pr-2">
                                <p class="text-center text-gray-500">Your selected sections will appear here.</p>
                            </div>
                            <div id="conflict-message" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden" role="alert">
                                <p class="font-bold">TIME CONFLICT DETECTED!</p>
                                <p class="text-sm">Please review your selections. You have overlapping class times.</p>
                            </div>
                        </div>
                    </div>
                `;
                // Run render functions for this view
                renderAssignmentCourseList();
                renderScheduleSummary();
                // populateTimeSlotFilter(); // <-- This was correctly removed
                
                // <<< CALLS THE LISTENER SETUP FUNCTION >>>
                setupFilterToggleListener(); 
                
                // Attach modal close handlers
                document.getElementById('modal-close-btn').onclick = closeRoutineModal;
                document.getElementById('routine-modal').onclick = closeRoutineModal;
                // Attach ICS export handler
                document.getElementById('export-ics-btn').onclick = generateICSFile;
                // Attach View Routine Button
                document.getElementById('view-routine-btn').onclick = openRoutineModal;
                // Prevent modal content click from closing
                document.querySelector('.modal-content').onclick = (e) => e.stopPropagation();
            }
        }

        /** Renders the view (course selection or section assignment) */
        window.changeView = function(newView) {
            viewState = newView;
            // Clear current filters when leaving View 2
            if (newView === 'courseSelection') {
                currentFilters = { faculty: [], time: [], day: [] };
                currentView2CourseKey = null;
            }
            renderApp();
        }

        // --- View 1: Course Selection and Filtering (FIX: Added back) ---

        /** Populates the program filter dropdown. */
        function populateProgramFilter() {
            const filter = document.getElementById('program-filter');
            if (!filter) return;
            filter.innerHTML = uniquePrograms.map(program =>
                `<option value="${program}">${program}</option>`
            ).join('');
            filter.value = 'All Programs'; // Default selection
        }

        /** Filters uniqueCourses based on search term and program selection. */
        window.filterAndRenderCourses = function() {
            const searchInput = document.getElementById('course-search');
            const programFilter = document.getElementById('program-filter');

            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            const selectedProgram = programFilter ? programFilter.value : 'All Programs';

            const filteredCourses = uniqueCourses.filter(course => {
                const matchesSearch = course['Formal Code'].toLowerCase().includes(searchTerm) ||
                                      course['Title'].toLowerCase().includes(searchTerm);

                const matchesProgram = selectedProgram === 'All Programs' || course['Program'] === selectedProgram;

                return matchesSearch && matchesProgram;
            });

            renderFilteredCourseList(filteredCourses);
        }

        /** Renders the list of filtered courses in View 1. */
        function renderFilteredCourseList(courses) {
            const listElement = document.getElementById('course-list-selection');
            const summaryElement = document.getElementById('pre-selected-summary');
            const goBtn = document.getElementById('go-to-assignment-btn');
            if (!listElement || !summaryElement || !goBtn) return;

            // Sort courses by Formal Code for clarity
            courses.sort((a, b) => a['Formal Code'].localeCompare(b['Formal Code']));

            listElement.innerHTML = '';
            summaryElement.innerHTML = '';

            let selectedCount = 0;

            courses.forEach(course => {
                const key = course.key;
                const isSelected = selectedCoursesForAssignment.has(key);

                // --- Render Course List Card ---
                const card = document.createElement('div');
                card.className = `w-full text-left p-3 rounded-xl border-2 cursor-pointer transition duration-150 ease-in-out flex justify-between items-center
                                    ${isSelected ? 'course-selected' : 'bg-white border-gray-200 hover:bg-gray-100'}`;
                card.innerHTML = `
                    <div>
                        <div class="font-bold text-base text-gray-900">${course['Formal Code']} (${course['Cr.']} Cr.)</div>
                        <div class="text-sm text-gray-600">${course['Title']}</div>
                        <div class="text-xs font-medium text-indigo-500">${course['Program']}</div>
                    </div>
                `;

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = isSelected;
                checkbox.className = 'w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500';
                checkbox.onclick = (e) => handleCourseToggle(key, e);

                card.appendChild(checkbox);
                listElement.appendChild(card);

                // --- Render Pre-Selected Summary ---
                if (isSelected) {
                    selectedCount++;
                    const summaryItem = document.createElement('div');
                    summaryItem.className = 'p-3 rounded-lg bg-indigo-50 text-indigo-800 border border-indigo-200 text-sm font-semibold';
                    summaryItem.textContent = `${course['Formal Code']} - ${course['Title']}`;
                    summaryElement.appendChild(summaryItem);
                }
            });

            if (selectedCount === 0) {
                    summaryElement.innerHTML = '<p class="text-center text-gray-500">No courses selected yet.</p>';
            }

            // Update button state and text
            goBtn.disabled = selectedCount === 0;
            goBtn.textContent = `Go to Section Assignment (${selectedCount})`;
        }

        /** Handles course selection/deselection in View 1. */
        function handleCourseToggle(courseKey, event) {
            // Stop propagation to prevent card click event if we were using it
            event.stopPropagation();

            if (selectedCoursesForAssignment.has(courseKey)) {
                selectedCoursesForAssignment.delete(courseKey);
                // Also remove section assignment if user decides to drop the course entirely
                delete selectedSections[courseKey];
            } else {
                selectedCoursesForAssignment.add(courseKey);
            }

            // Re-render the course list to update colors and the summary panel
            filterAndRenderCourses();
        }

        
        // --- View 2: Section Assignment and Filtering (Modified Logic) ---

        /** Updates the current filter state and re-renders sections. */
        window.handleFilterChange = function(type, value, isChecked) {
            // Update the array in currentFilters
            if (isChecked) {
                if (!currentFilters[type].includes(value)) {
                    currentFilters[type].push(value);
                }
            } else {
                currentFilters[type] = currentFilters[type].filter(v => v !== value);
            }
            
            // Trigger the re-render of sections
            filterAndRenderSections();
        }

        /** Renders the time slot checkboxes based on course type (Lab/Theory) */
        function populateTimeSlotFilter(courseKey) {
            const container = document.getElementById('time-filter-container');
            const course = uniqueCourses.find(c => c.key === courseKey);
            if (!container || !course) return;

            container.innerHTML = ''; // Clear previous content
            
            const isLab = parseFloat(course['Cr.']) === 1.0;
            const slotsToRender = isLab ? LAB_SLOTS : THEORY_SLOTS;

            slotsToRender.forEach(slot => {
                const isSelected = currentFilters.time.includes(slot);
                const div = document.createElement('div');
                div.className = 'flex items-start';
                div.innerHTML = `
                    <input id="time-${slot.replace(/\s/g, '_')}" type="checkbox" value="${slot}" 
                        ${isSelected ? 'checked' : ''}
                        onchange="handleFilterChange('time', this.value, this.checked)"
                        class="mt-1 h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer">
                    <label for="time-${slot.replace(/\s/g, '_')}" class="ml-2 block text-xs text-gray-700 cursor-pointer">${slot}</label>
                `;
                container.appendChild(div);
            });
        }
        
        /** Renders the day checkboxes based on course type (Lab/Theory) */
        function populateDayFilter(courseKey) {
            const container = document.getElementById('day-filter-container');
            const course = uniqueCourses.find(c => c.key === courseKey);
            if (!container || !course) return;

            container.innerHTML = ''; // Clear previous content
            
            const isLab = parseFloat(course['Cr.']) === 1.0;
            const daysToRender = isLab ? LAB_DAYS : THEORY_DAYS;

            daysToRender.forEach(day => {
                const isSelected = currentFilters.day.includes(day);
                const div = document.createElement('div');
                div.className = 'flex items-start';
                div.innerHTML = `
                    <input id="day-${day.replace('/', '_')}" type="checkbox" value="${day}" 
                        ${isSelected ? 'checked' : ''}
                        onchange="handleFilterChange('day', this.value, this.checked)"
                        class="mt-1 h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer">
                    <label for="day-${day.replace('/', '_')}" class="ml-2 block text-xs text-gray-700 cursor-pointer">${day}</label>
                `;
                container.appendChild(div);
            });
        }


        /** Dynamically renders the Faculty checkboxes for the selected course. */
        function populateFacultyFilter(courseKey) {
            const container = document.getElementById('faculty-filter-container');
            if (!container) return;

            container.innerHTML = '';
            
            // 1. Get unique faculty for this specific course
            const courseSections = allCoursesData.filter(row => getCourseKey(row) === courseKey);
            const uniqueFaculty = {};

            courseSections.forEach(row => {
                const initial = row['Initial'];
                if (initial) {
                    uniqueFaculty[initial] = row['Faculty Full Name'];
                }
            });

            const sortedInitials = Object.keys(uniqueFaculty).sort();

            if (sortedInitials.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-500">No faculty assigned.</p>';
                // Reset faculty filter when changing course
                currentFilters.faculty = [];
                return;
            }
            
            // 2. Render Checkboxes
            sortedInitials.forEach(initial => {
                const fullName = uniqueFaculty[initial];
                const isSelected = currentFilters.faculty.includes(initial);
                
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input id="faculty-${initial}" type="checkbox" value="${initial}"
                        ${isSelected ? 'checked' : ''}
                        onchange="handleFilterChange('faculty', this.value, this.checked)"
                        class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer">
                    <label for="faculty-${initial}" class="ml-2 block text-sm text-gray-700 cursor-pointer truncate" title="${fullName}">${fullName} (${initial})</label>
                `;
                container.appendChild(div);
            });
        }

        /** Helper to check if a course time slot matches any of the selected filter slots. */
        function timeSlotMatchesFilter(sectionData, selectedTimeSlots) {
            if (selectedTimeSlots.length === 0) return true; // No filter applied

            const schedule = getSectionSchedule(sectionData);

            for (const slot of schedule) {
                if (slot.start !== -1 && slot.end !== -1) {
                    // Reconstruct the exact time string used in the filter slots
                    const courseTimeRangeStr = `${timeSlotToString(slot.start)} - ${timeSlotToString(slot.end)}`;
                    
                    if (selectedTimeSlots.includes(courseTimeRangeStr)) {
                        return true;
                    }
                }
            }
            
            return false;
        }
        
        /** Helper to check if a course day matches any of the selected filter days. */
        function dayMatchesFilter(sectionData, selectedDays) {
            if (selectedDays.length === 0) return true; // No filter applied

            const day1 = sectionData['Day1'];
            const day2 = sectionData['Day2'];

            // Handle Theory (e.g., "Sat/Tue")
            if (day1 && day2 && day1 !== '-' && day2 !== '-') {
                const combinedDays = `${day1}/${day2}`;
                if (selectedDays.includes(combinedDays)) {
                    return true;
                }
            } 
            // Handle Lab (e.g., "Sat")
            else if (day1 && day1 !== '-') {
                 if (selectedDays.includes(day1)) {
                    return true;
                }
            }
            
            return false;
        }

        /** Filters and renders sections for the currently selected course in View 2. */
        window.filterAndRenderSections = function() {
            const listElement = document.getElementById('section-list');
            const filterContainer = document.getElementById('section-filters-wrapper'); // Use wrapper to control visibility
            const courseKey = currentView2CourseKey; // Use globally stored active key

            if (!courseKey || !listElement || !filterContainer) {
                if (listElement) listElement.innerHTML = '<p class="text-center text-gray-500 mt-4">Select a course to view available sections.</p>';
                if (filterContainer) filterContainer.classList.add('hidden');
                return;
            }
            
            if (filterContainer) filterContainer.classList.remove('hidden');

            // 1. Get all sections for the course
            let filteredSections = allCoursesData.filter(row => getCourseKey(row) === courseKey);

            // 2. Apply Filters

            // Filter 1: Faculty (Multi-select by Initial)
            if (currentFilters.faculty.length > 0) {
                filteredSections = filteredSections.filter(section => 
                    currentFilters.faculty.includes(section['Initial'])
                );
            }
            
            // Filter 2: Time Slot (Multi-select by full time string)
            if (currentFilters.time.length > 0) {
                filteredSections = filteredSections.filter(section => 
                    timeSlotMatchesFilter(section, currentFilters.time)
                );
            }
            
            // Filter 3: Day (Multi-select by day string)
            if (currentFilters.day.length > 0) {
                filteredSections = filteredSections.filter(section => 
                    dayMatchesFilter(section, currentFilters.day)
                );
            }
            
            // --- Rendering Logic ---
            listElement.innerHTML = '';
            if (filteredSections.length === 0) {
                listElement.innerHTML = '<div class="text-center p-6 bg-yellow-50 border border-yellow-300 text-yellow-800 rounded-lg">No sections match the current filters for this course. Try clearing the filters.</div>';
                return;
            }

            // Sort by Section Number/Type first, then by Time
            filteredSections.sort((a, b) => {
                if (a['Section'] !== b['Section']) {
                    return a['Section'].localeCompare(b['Section']);
                }
                // Simple time comparison by string sort for consistency if no time filter is active
                return (a['Time1'] || a['Time2'] || '').localeCompare(b['Time1'] || b['Time2'] || '');
            });
            
            const courseInfo = uniqueCourses.find(c => c.key === courseKey);
            const currentlySelectedSection = selectedSections[courseKey];

            filteredSections.forEach(section => {
                const sectionKey = section.Section; // Section identifier (e.g., 01, L01)
                const isSelected = currentlySelectedSection && currentlySelectedSection.Section === sectionKey;
                const conflictSection = findConflict(section, selectedSections);
                const isConflict = conflictSection && conflictSection.Section !== section.Section;
                
                const scheduleText = getSectionSchedule(section).map(slot => `${slot.day} ${timeSlotToString(slot.start)}-${timeSlotToString(slot.end)}`).join('; ');
                const conflictInfo = isConflict ? 
                    `<span class="text-red-600 font-bold">CONFLICTS with ${getCourseKey(conflictSection).split('_')[0]} ${conflictSection.Section}</span>` : 
                    '<span class="text-green-600 font-bold">No Time Conflicts</span>';


                const card = document.createElement('div');
                card.className = `section-card p-3 rounded-xl border-2 cursor-pointer transition duration-150 ease-in-out ${isSelected ? 'selected' : isConflict ? 'conflict' : 'border-gray-200 bg-white hover:bg-gray-50'}`;
                card.onclick = () => handleSectionSelect(section, isConflict);
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-extrabold text-lg text-indigo-700">${section.Section}</span>
                        <span class="text-sm font-medium text-gray-500">${section['Type']}</span>
                    </div>
                    <p class="text-sm font-semibold text-gray-800">${section['Faculty Full Name']} (${section['Initial']})</p>
                    <p class="text-xs text-gray-600">${scheduleText}</p>
                    <div class="mt-2 text-xs">${conflictInfo}</div>
                `;
                listElement.appendChild(card);
            });
        }
        
        /** Helper to re-render the section list and schedule summary after an action */
        function updateView2State() {
            renderScheduleSummary();
            filterAndRenderSections(); // Re-render sections in case conflict status changed
        }

        /** Handles section selection/replacement in View 2. */
        window.handleSectionSelect = function(newSectionData, isConflict) {
            const courseKey = getCourseKey(newSectionData);
            
            // 1. Check if this course already has a section selected
            if (selectedSections[courseKey]) {
                // If selecting the *same* section again, deselect it (Remove course)
                if (selectedSections[courseKey].Section === newSectionData.Section) {
                    delete selectedSections[courseKey];
                } 
                // If selecting a *different* section, replace it (replacement handles conflict checking internally)
                else if (!isConflict) { 
                    selectedSections[courseKey] = newSectionData;
                } else {
                    alert(`Cannot select ${newSectionData.Section} as it conflicts with an existing section in your schedule!`);
                    return;
                }
            } 
            // 2. If no section selected, select this one (check for external conflicts)
            else if (!isConflict) {
                selectedSections[courseKey] = newSectionData;
            } else {
                alert(`Cannot select ${newSectionData.Section} due to a time conflict with another course already in your schedule!`);
                return;
            }
            
            updateView2State();
        }


        /** Renders the horizontal list of selected courses at the top of View 2. */
        function renderAssignmentCourseList() {
            const listElement = document.getElementById('assignment-course-list');
            if (!listElement) return;

            listElement.innerHTML = '';

            const courseKeys = Array.from(selectedCoursesForAssignment);
            
            if (courseKeys.length === 0) {
                listElement.innerHTML = '<p class="text-gray-500 p-2">Select courses in Phase 1 to begin.</p>';
                return;
            }

            courseKeys.forEach(key => {
                const course = uniqueCourses.find(c => c.key === key);
                const isCurrent = currentView2CourseKey === key;
                const hasSection = selectedSections[key];
                
                if (course) {
                    const button = document.createElement('button');
                    button.className = `w-40 shrink-0 text-left p-3 rounded-lg border-2 transition duration-150 ease-in-out whitespace-nowrap overflow-hidden text-ellipsis ${
                        isCurrent 
                        ? 'bg-indigo-100 border-indigo-500 text-indigo-900 font-bold shadow-md' 
                        : hasSection 
                        ? 'bg-green-50 border-green-400 text-green-800 hover:bg-green-100'
                        : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50'
                    }`;
                    button.innerHTML = `
                        <div class="font-bold text-sm truncate">${course['Formal Code']}</div>
                        <div class="text-xs truncate">${course['Title']}</div>
                        ${hasSection ? `<div class="text-xs mt-1 font-semibold text-right">${hasSection.Section} ${hasSection.Type}</div>` : ''}
                    `;
                    button.onclick = () => switchView2Course(key);
                    listElement.appendChild(button);
                }
            });
        }
        
        /** Switches the active course being viewed/filtered in View 2. */
        window.switchView2Course = function(key) {
            currentView2CourseKey = key;
            
            // Reset filters for the new course
            currentFilters = { faculty: [], time: [], day: [] };
            
            // 1. Re-render course list to update button focus state
            renderAssignmentCourseList();
            
            // 2. Populate filters based on the *new* course's faculty
            populateFacultyFilter(key);
            populateTimeSlotFilter(key);
            populateDayFilter(key);
            
            // 3. Re-render section list (which also checks conflicts)
            filterAndRenderSections();
            
            // 4. Update course info header
            const course = uniqueCourses.find(c => c.key === key);
            document.getElementById('selected-course-info').innerHTML = `
                Viewing Sections for: <strong class="text-indigo-700">${course['Formal Code']} - ${course['Title']}</strong> 
                (${course['Cr.']} Credits)
            `;
        }

        /** Renders the list of selected sections and checks for overall schedule conflicts. */
        function renderScheduleSummary() {
            const summaryElement = document.getElementById('schedule-summary');
            const creditsElement = document.getElementById('total-credits');
            const conflictMessage = document.getElementById('conflict-message');
            const routineBtn = document.getElementById('view-routine-btn'); // Get routine button
            if (!summaryElement || !creditsElement || !conflictMessage || !routineBtn) return;

            summaryElement.innerHTML = '';
            let totalCredits = 0;
            let overallConflict = false;

            // Ensure we only check sections for courses that are *selected*
            const sectionKeys = Object.keys(selectedSections);
            
            if (sectionKeys.length === 0) {
                summaryElement.innerHTML = '<p class="text-center text-gray-500">Your schedule is empty.</p>';
                creditsElement.textContent = 'Credits: 0';
                conflictMessage.classList.add('hidden');
                routineBtn.disabled = true; // Disable button
                return;
            }

            // Enable button if we have sections
            routineBtn.disabled = false;

            sectionKeys.forEach(courseKey => {
                const sectionData = selectedSections[courseKey];
                
                // Re-run conflict check against all *other* selections
                const conflict = findConflict(sectionData, selectedSections);
                
                if (conflict) {
                    overallConflict = true;
                }

                // Find course metadata for credits and title
                const courseMeta = uniqueCourses.find(c => c.key === courseKey);
                if (courseMeta) {
                    totalCredits += parseFloat(courseMeta['Cr.']) || 0;
                }
                
                const scheduleText = getSectionSchedule(sectionData).map(slot => `${slot.day} ${timeSlotToString(slot.start)}-${timeSlotToString(slot.end)}`).join('; ');

                const item = document.createElement('div');
                item.className = `p-3 rounded-lg border shadow-sm ${conflict ? 'bg-red-50 border-red-300' : 'bg-white border-gray-200'}`;
                item.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="font-bold text-sm">${courseMeta['Formal Code']} - ${sectionData.Section}</div>
                        <button onclick="handleRemoveSection('${courseKey}')" class="text-xs text-red-500 hover:text-red-700 font-semibold ml-2">[X]</button>
                    </div>
                    <p class="text-xs text-gray-600 truncate">${courseMeta['Title']}</p>
                    <p class="text-xs text-gray-500 truncate">${sectionData['Faculty Full Name']}</p>
                    <p class="text-[10px] mt-1 ${conflict ? 'text-red-700 font-semibold' : 'text-green-600'}">${scheduleText}</p>
                `;
                summaryElement.appendChild(item);
            });

            creditsElement.textContent = `Credits: ${totalCredits.toFixed(1)}`;
            conflictMessage.classList.toggle('hidden', !overallConflict);
        }

        /** Removes a course entirely from the schedule in View 2. */
        window.handleRemoveSection = function(courseKey) {
            delete selectedSections[courseKey];
            selectedCoursesForAssignment.delete(courseKey); // Also remove from Phase 1 selection tracking
            
            // Re-render everything that depends on selections
            renderAssignmentCourseList();
            renderScheduleSummary();
            filterAndRenderCourses(); // Re-render the course list in View 1 if we switch back
            
            // If we were viewing the section list for this course, switch back to the first available
            if (currentView2CourseKey === courseKey) {
                currentView2CourseKey = null;
                filterAndRenderSections(); // This will reset the section panel to "Select a course..."
            }
        }
        
        
        // --- NEW: Routine Modal and Calendar Functions ---
        
        /** Opens the Routine Modal and renders the calendar */
        window.openRoutineModal = function() {
            const modal = document.getElementById('routine-modal');
            if (modal) {
                renderRoutineCalendar();
                modal.classList.remove('hidden');
                modal.classList.add('opacity-100');
            }
        }

        /** Closes the Routine Modal */
        window.closeRoutineModal = function() {
            const modal = document.getElementById('routine-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('opacity-100');
            }
        }

        /** Rrenders the dynamic calendar grid inside the modal */
        function renderRoutineCalendar() {
            const container = document.getElementById('calendar-grid-container');
            if (!container) return;

            container.innerHTML = ''; // Clear old grid

            const days = ["Sat", "Sun", "Tue", "Wed"];
            const gridStartTime = 480; // 8:00 AM in minutes
            const gridEndTime = 1050; // 5:30 PM (1020 is 5:00, 1050 is 5:30)
            const rowUnit = 10; // Use 10-minute increments for precision
            const rowCount = (gridEndTime - gridStartTime) / rowUnit; // 57 rows
            
            // 1. Create Header Row
            container.innerHTML += `<div class="calendar-header calendar-time-cell">Time</div>`;
            days.forEach(day => {
                container.innerHTML += `<div class="calendar-header">${day}</div>`;
            });
            
            // 2. Create Time Slot Rows
            for (let i = 0; i < rowCount; i++) {
                const rowTime = gridStartTime + (i * rowUnit);
                const mins = rowTime % 60;
                
                // Add time cell, but only for :00 and :30
                if (mins === 0 || mins === 30) {
                    const timeString = timeSlotToString(rowTime);
                    container.innerHTML += `<div class="calendar-time-cell" style="grid-row: ${i + 2};">${timeString}</div>`;
                } else {
                     // Add an empty cell to maintain grid structure but show no text
                    container.innerHTML += `<div class="calendar-time-cell" style="grid-row: ${i + 2}; border-color: transparent;"></div>`;
                }
                
                // Add empty day cells (for grid lines)
                days.forEach((day, dayIndex) => {
                     container.innerHTML += `<div style="grid-row: ${i + 2}; grid-column: ${dayIndex + 2};"></div>`;
                });
            }
            
            // 3. Place Class Cells
            Object.values(selectedSections).forEach(section => {
                const schedule = getSectionSchedule(section);
                const courseMeta = uniqueCourses.find(c => c.key === getCourseKey(section));
                
                schedule.forEach(slot => {
                    if (slot.start === -1) return; // Skip invalid slots

                    const colStart = days.indexOf(slot.day) + 2; // +1 for index, +1 for time col
                    
                    const rowStart = Math.floor((slot.start - gridStartTime) / rowUnit) + 2;
                    const rowEnd = Math.ceil((slot.end - gridStartTime) / rowUnit) + 2;

                    if (colStart < 2) return; // Day not in our calendar (e.g., Mon, Thu, Fri)

                    const cell = document.createElement('div');
                    cell.className = 'calendar-class-cell';
                    cell.style.cssText = `
                        --col-start: ${colStart};
                        --row-start: ${rowStart};
                        --row-end: ${rowEnd};
                    `;
                    
                    // *** UPDATED with Room Number ***
                    cell.innerHTML = `
                        <strong>${courseMeta['Formal Code']} (${section.Section}) - Room ${section['Room1']}</strong>
                        <p class="text-xs text-gray-700 truncate">${courseMeta['Title']}</p>
                        <p class="text-xs text-gray-500 truncate">${section['Faculty Full Name']}</p>
                        <p class="text-xs text-gray-600 mt-1">${timeSlotToString(slot.start)} - ${timeSlotToString(slot.end)}</p>
                    `;
                    container.appendChild(cell);
                });
            });
        }


        // --- NEW: ICS Export Functions ---
        
        /** Formats a JS Date into ICS UTC format (YYYYMMDDTHHMMSSZ) */
        function formatICSDate(date) {
            return date.getUTCFullYear() +
                String(date.getUTCMonth() + 1).padStart(2, '0') +
                String(date.getUTCDate()).padStart(2, '0') +
                'T' +
                String(date.getUTCHours()).padStart(2, '0') +
                String(date.getUTCMinutes()).padStart(2, '0') +
                String(date.getUTCSeconds()).padStart(2, '0') +
                'Z';
        }

        /** Gets the day number (Sunday=0, Saturday=6) */
        function getDayOfWeekNumber(dayStr) {
            switch (dayStr) {
                case "Sun": return 0;
                case "Mon": return 1;
                case "Tue": return 2;
                case "Wed": return 3;
                case "Thu": return 4;
                case "Fri": return 5;
                case "Sat": return 6;
                default: return -1;
            }
        }

        /** Triggers the .ics file download */
        function downloadICS(filename, text) {
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/calendar;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        /** Main function to generate and download the ICS file */
        window.generateICSFile = function() {
            let icsString = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//UniversityCourseScheduler//NONSGML v1.0//EN',
            ];

            const today = new Date();
            // Find the next Sunday to start the "semester"
            const semesterStart = new Date(today);
            semesterStart.setDate(today.getDate() - today.getDay()); // Go back to last Sunday
            semesterStart.setHours(0, 0, 0, 0);
            
            // Assuming a 14-week semester (13 * 7 days)
            const semesterEnd = new Date(semesterStart);
            semesterEnd.setDate(semesterStart.getDate() + (13 * 7));
            const untilDate = formatICSDate(semesterEnd).split('T')[0]; // YYYYMMDD

            const dayMap = { "Sat": "SA", "Sun": "SU", "Tue": "TU", "Wed": "WE" };

            Object.values(selectedSections).forEach(section => {
                const courseMeta = uniqueCourses.find(c => c.key === getCourseKey(section));
                const schedule = getSectionSchedule(section);
                
                schedule.forEach(slot => {
                    if (slot.start === -1 || !dayMap[slot.day]) return;

                    const dayNum = getDayOfWeekNumber(slot.day);
                    const classDate = new Date(semesterStart);
                    classDate.setDate(semesterStart.getDate() + dayNum);
                    
                    // Set start time
                    const startH = Math.floor(slot.start / 60);
                    const startM = slot.start % 60;
                    classDate.setHours(startH, startM, 0);
                    const dtstart = formatICSDate(classDate);

                    // Set end time
                    const endH = Math.floor(slot.end / 60);
                    const endM = slot.end % 60;
                    classDate.setHours(endH, endM, 0);
                    const dtend = formatICSDate(classDate);

                    icsString.push('BEGIN:VEVENT');
                    icsString.push(`UID:${courseMeta['Formal Code']}-${section.Section}-${slot.day}@coursescheduler`);
                    icsString.push(`SUMMARY:${courseMeta['Formal Code']} (${section.Section}) - ${section['Room1']}`);
                    icsString.push(`DESCRIPTION:Course: ${courseMeta['Title']}\\nFaculty: ${section['Faculty Full Name']}\\nRoom: ${section['Room1']}`);
                    icsString.push(`LOCATION:${section['Room1']}`);
                    icsString.push(`DTSTART;TZID=Etc/UTC:${dtstart}`);
                    icsString.push(`DTEND;TZID=Etc/UTC:${dtend}`);
                    icsString.push(`RRULE:FREQ=WEEKLY;BYDAY=${dayMap[slot.day]};UNTIL=${untilDate}`);
                    icsString.push('END:VEVENT');
                });
            });

            icsString.push('END:VCALENDAR');
            downloadICS('My_Schedule.ics', icsString.join('\r\n'));
        }

        // --- FUNCTION TO HANDLE COLLAPSIBLE FILTER TOGGLE ---
        function setupFilterToggleListener() {
            const filterToggle = document.getElementById('filterToggle');
            const filterContent = document.getElementById('filterContent');
            const arrowIcon = document.getElementById('arrowIcon');

            // Check if elements exist
            if (filterToggle && filterContent && arrowIcon) {
                // Add the click listener
                filterToggle.addEventListener('click', function() {
                    
                    // 1. Toggle the 'hidden' class on the content container
                    filterContent.classList.toggle('hidden');
                    
                    // 2. Change the arrow icon to indicate state
                    if (filterContent.classList.contains('hidden')) {
                        // Content is now hidden: Arrow points right (closed)
                        arrowIcon.innerHTML = 'â–¶';
                    } else {
                        // Content is now visible: Arrow points down (open)
                        arrowIcon.innerHTML = 'â–¼';
                    }
                });
            }
        }
        // ---------------------------------------------------------


        // --- Initialization ---
        initializeData();

    </script>

</body>
</html>
