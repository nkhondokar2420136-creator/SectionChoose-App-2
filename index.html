<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University Course Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, deleteDoc, writeBatch, where, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // setLogLevel('Debug'); // Uncomment for debugging

        // Global Firebase variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db, auth, userId = null;
        let unsubscribeUserSchedule = null;
        
        const COURSES_COLLECTION_NAME = 'selected_courses';

        // --- Utility Functions ---

        // Function to serialize complex data structures before saving
        const serialize = (data) => JSON.stringify(data);
        // Function to deserialize data structures after loading
        const deserialize = (data) => data ? JSON.parse(data) : null;
        
        /**
         * Converts time string (e.g., '08:30:AM') to minutes from midnight.
         * @param {string} timeStr - The time string.
         * @returns {number} Minutes from midnight.
         */
        function timeToMinutes(timeStr) {
            if (!timeStr || timeStr === ' - ') return -1;
            const [time, period] = timeStr.split(':');
            let hours = parseInt(time.match(/\d+/)[0], 10);
            let minutes = parseInt(time.match(/:\d+/)[0].substring(1), 10);

            if (period && period.includes('PM') && hours !== 12) {
                hours += 12;
            } else if (period && period.includes('AM') && hours === 12) {
                hours = 0; // Midnight (12:xx AM) is 0 hours
            }
            return hours * 60 + minutes;
        }

        /**
         * Gets the Firestore collection path for the user's private data.
         * @returns {string} The Firestore path.
         */
        const getUserScheduleCollectionRef = () => {
            return `artifacts/${appId}/users/${userId}/${COURSES_COLLECTION_NAME}`;
        };

        // --- Core Scheduler Logic ---

        /**
         * Checks for time conflicts between the new course and the currently selected courses.
         * @param {object} newCourse - The course to check.
         * @param {object[]} currentSchedule - The array of currently selected courses.
         * @returns {string | null} Conflict message or null if no conflict.
         */
        const checkConflict = (newCourse, currentSchedule) => {
            const days = ['Sat', 'Sun', 'Mon', 'Tue', 'Wed', 'Thu'];

            // Get the time slots for the new course
            const newTimes = [];
            if (newCourse.Day1 && newCourse.Time1 && newCourse.Time1 !== ' - ') {
                const [start, end] = newCourse.Time1.split(' - ').map(t => timeToMinutes(t));
                newTimes.push({ day: newCourse.Day1, start, end });
            }
            if (newCourse.Day2 && newCourse.Time2 && newCourse.Time2 !== ' - ') {
                const [start, end] = newCourse.Time2.split(' - ').map(t => timeToMinutes(t));
                newTimes.push({ day: newCourse.Day2, start, end });
            }

            for (const existingCourse of currentSchedule) {
                // Ignore conflicts with itself if this is an update scenario (though we use array filtering here)
                if (existingCourse.id === newCourse.id) continue;

                const existingTimes = [];
                if (existingCourse.Day1 && existingCourse.Time1 && existingCourse.Time1 !== ' - ') {
                    const [start, end] = existingCourse.Time1.split(' - ').map(t => timeToMinutes(t));
                    existingTimes.push({ day: existingCourse.Day1, start, end });
                }
                if (existingCourse.Day2 && existingCourse.Day2 !== existingCourse.Day1 && existingCourse.Time2 && existingCourse.Time2 !== ' - ') {
                    const [start, end] = existingCourse.Time2.split(' - ').map(t => timeToMinutes(t));
                    existingTimes.push({ day: existingCourse.Day2, start, end });
                }

                for (const newTime of newTimes) {
                    for (const existingTime of existingTimes) {
                        if (newTime.day === existingTime.day) {
                            // Check for overlap: (StartA < EndB) and (EndA > StartB)
                            if (newTime.start < existingTime.end && newTime.end > existingTime.start) {
                                return `Conflict: ${newCourse.FormalCode} ${newCourse.Section} conflicts with ${existingCourse.FormalCode} ${existingCourse.Section} on ${newTime.day}.`;
                            }
                        }
                    }
                }
            }

            return null; // No conflict
        };
        
        // --- Firebase Interaction ---

        /**
         * Fetches and parses the CSV data.
         * @returns {Promise<object[]>} The array of course objects.
         */
        async function fetchCourseData() {
            try {
                // The filename is accessible as a global variable
                const filename = 'course_offerings.csv';
                const response = await fetch(filename);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const csvText = await response.text();
                const lines = csvText.trim().split('\r\n');
                const headers = lines[0].split(',').map(h => h.trim().replace('.', ''));
                
                const courses = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    if (values.length !== headers.length) continue; 
                    
                    const course = {};
                    headers.forEach((header, index) => {
                        // Clean up time strings: replace empty with ' - '
                        let value = values[index].trim();
                        if ((header === 'Time1' || header === 'Time2') && value === '') {
                            value = ' - ';
                        }
                        course[header] = value;
                    });
                    course.id = `${course.FormalCode}-${course.Section}`;
                    courses.push(course);
                }

                return courses;
            } catch (error) {
                console.error("Failed to fetch or parse CSV data:", error);
                document.getElementById('error-message').textContent = 'Error loading course data.';
                return [];
            }
        }

        /**
         * Adds a course to the user's schedule in Firestore.
         * @param {object} course - The course object to add.
         */
        async function addCourseToSchedule(course) {
            if (!userId) {
                displayMessage('Authentication not ready.', 'error');
                return;
            }

            try {
                // Get current schedule to check for conflicts before saving
                const scheduleRef = collection(db, getUserScheduleCollectionRef());
                const querySnapshot = await getDocs(scheduleRef);
                const currentSchedule = querySnapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...deserialize(doc.data().course) // Deserialize course object
                }));

                const conflict = checkConflict(course, currentSchedule);
                if (conflict) {
                    displayMessage(conflict, 'error');
                    return;
                }

                // If no conflict, add the course
                const courseDocRef = doc(db, getUserScheduleCollectionRef(), course.id);
                
                // Store the course object serialized as a string
                await setDoc(courseDocRef, {
                    course: serialize(course),
                    timestamp: Date.now(),
                     FormalCode: course.FormalCode, // For potential future query filtering
                    Section: course.Section
                });

                displayMessage(`Added ${course.FormalCode} ${course.Section} to schedule!`, 'success');

            } catch (e) {
                console.error("Error adding course: ", e);
                displayMessage('Failed to add course due to a database error.', 'error');
            }
        }

        /**
         * Removes a course from the user's schedule in Firestore.
         * @param {string} courseId - The unique ID of the course document (FormalCode-Section).
         */
        async function removeCourseFromSchedule(courseId) {
            if (!userId) {
                displayMessage('Authentication not ready.', 'error');
                return;
            }

            try {
                const courseDocRef = doc(db, getUserScheduleCollectionRef(), courseId);
                await deleteDoc(courseDocRef);
                displayMessage(`Removed course ID ${courseId} from schedule.`, 'success');
            } catch (e) {
                console.error("Error removing course: ", e);
                displayMessage('Failed to remove course due to a database error.', 'error');
            }
        }

        // --- UI Rendering and Handlers ---

        let allCourses = [];
        let userSchedule = [];

        /**
         * Renders the list of available courses based on the current search term and filters.
         * @param {object[]} courses - The array of courses to render.
         * @param {string} searchTerm - The current search term.
         */
        function renderAvailableCourses(courses, searchTerm) {
            const listContainer = document.getElementById('available-courses-list');
            listContainer.innerHTML = '';
            
            const filteredCourses = courses.filter(course => 
                !userSchedule.some(s => s.id === course.id) &&
                (searchTerm === '' || 
                 course.FormalCode.toLowerCase().includes(searchTerm.toLowerCase()) || 
                 course.Title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                 course.Initial.toLowerCase().includes(searchTerm.toLowerCase()))
            );

            if (filteredCourses.length === 0) {
                listContainer.innerHTML = `<p class="text-gray-500 p-4">No available courses match your search or you've already added them.</p>`;
                return;
            }

            filteredCourses.forEach(course => {
                const courseDiv = document.createElement('div');
                courseDiv.className = 'flex items-center justify-between p-3 border-b border-gray-100 hover:bg-indigo-50 transition duration-150 ease-in-out';
                
                let timeInfo = `${course.Day1} (${course.Time1})`;
                if (course.Day2) {
                    timeInfo += course.Day2 !== course.Day1 ? ` | ${course.Day2} (${course.Time2})` : '';
                }

                courseDiv.innerHTML = `
                    <div class="flex-grow min-w-0">
                        <div class="font-semibold text-gray-800 truncate">${course.FormalCode} - ${course.Section}</div>
                        <div class="text-sm text-indigo-700">${course.Title} (${course.Cr} Cr)</div>
                        <div class="text-xs text-gray-500">${timeInfo} by ${course.Initial}</div>
                        <div class="text-xs text-gray-500 mt-1">Room: ${course.Room1} ${course.Room2 ? `| ${course.Room2}` : ''}</div>
                    </div>
                    <button class="add-button ml-4 px-3 py-1 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md flex-shrink-0" data-course='${serialize(course)}'>
                        Add
                    </button>
                `;
                listContainer.appendChild(courseDiv);
            });

            // Add event listeners to the new Add buttons
            listContainer.querySelectorAll('.add-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const courseData = JSON.parse(e.currentTarget.dataset.course);
                    addCourseToSchedule(courseData);
                });
            });
        }

        /**
         * Renders the user's selected schedule.
         * @param {object[]} schedule - The array of selected course objects.
         */
        function renderUserSchedule(schedule) {
            userSchedule = schedule; // Update global state
            const listContainer = document.getElementById('user-schedule-list');
            listContainer.innerHTML = '';
            
            if (schedule.length === 0) {
                listContainer.innerHTML = `<p class="text-gray-500 p-4 text-center">Your schedule is empty. Add a course from the list above!</p>`;
                document.getElementById('total-credits').textContent = '0';
                return;
            }
            
            // Calculate total credits
            const totalCredits = schedule.reduce((sum, course) => sum + (parseFloat(course.Cr) || 0), 0);
            document.getElementById('total-credits').textContent = totalCredits.toFixed(0);

            // Sort schedule by day and time for better display
            const sortedSchedule = [...schedule].sort((a, b) => {
                const dayOrder = { 'Sat': 1, 'Sun': 2, 'Mon': 3, 'Tue': 4, 'Wed': 5, 'Thu': 6, 'Fri': 7 };
                const dayA = dayOrder[a.Day1] || 99;
                const dayB = dayOrder[b.Day1] || 99;
                
                if (dayA !== dayB) return dayA - dayB;
                
                const timeA = timeToMinutes(a.Time1);
                const timeB = timeToMinutes(b.Time1);
                return timeA - timeB;
            });

            sortedSchedule.forEach(course => {
                const courseDiv = document.createElement('div');
                courseDiv.className = 'flex items-center justify-between p-3 border-b border-indigo-100 bg-white shadow-sm rounded-lg mb-2';
                
                let timeInfo = `<span class="font-bold">${course.Day1}:</span> ${course.Time1}`;
                if (course.Day2 && course.Day2 !== course.Day1) {
                    timeInfo += ` | <span class="font-bold">${course.Day2}:</span> ${course.Time2}`;
                }

                courseDiv.innerHTML = `
                    <div class="flex-grow min-w-0">
                        <div class="font-semibold text-lg text-gray-900">${course.FormalCode} - ${course.Section}</div>
                        <div class="text-sm text-indigo-800">${course.Title} (${course.Cr} Cr)</div>
                        <div class="text-xs text-gray-600 mt-1">${timeInfo}</div>
                    </div>
                    <button class="remove-button ml-4 p-2 text-red-500 hover:text-red-700 transition duration-150 flex-shrink-0" data-course-id="${course.id}">
                        <!-- Trash Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                listContainer.appendChild(courseDiv);
            });

            // Re-render available courses to remove the newly added ones from the list
            renderAvailableCourses(allCourses, document.getElementById('search-input').value);

            // Add event listeners to the new Remove buttons
            listContainer.querySelectorAll('.remove-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    removeCourseFromSchedule(e.currentTarget.dataset.courseId);
                });
            });
        }

        /**
         * Displays a temporary message (success or error) to the user.
         * @param {string} message - The message content.
         * @param {'success' | 'error'} type - The type of message.
         */
        function displayMessage(message, type) {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.className = `p-3 rounded-lg text-white font-medium mb-4 transition-opacity duration-300 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} opacity-100`;

            setTimeout(() => {
                messageBox.className = messageBox.className.replace('opacity-100', 'opacity-0');
            }, 3000);
        }

        /**
         * Initializes Firebase and sets up authentication listener.
         */
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Sign in using the custom token if provided, otherwise sign in anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId;
                        // Start listening to the schedule after successful authentication
                        setupScheduleListener();
                    } else {
                        userId = null;
                        document.getElementById('user-id-display').textContent = 'Guest';
                        if (unsubscribeUserSchedule) unsubscribeUserSchedule();
                    }
                });
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                document.getElementById('error-message').textContent = 'Failed to connect to the database.';
            }
        }

        /**
         * Sets up the real-time Firestore listener for the user's schedule.
         */
        function setupScheduleListener() {
            if (unsubscribeUserSchedule) {
                unsubscribeUserSchedule();
            }

            if (!userId) return;

            const scheduleRef = collection(db, getUserScheduleCollectionRef());
            // Query to order results by the timestamp of when they were added/updated
            const q = query(scheduleRef, orderBy('timestamp'));

            unsubscribeUserSchedule = onSnapshot(q, (snapshot) => {
                const currentSchedule = [];
                snapshot.forEach((doc) => {
                    // Deserialize the course object stored in the 'course' field
                    const courseData = deserialize(doc.data().course);
                    if (courseData) {
                        currentSchedule.push({
                            ...courseData,
                            docId: doc.id // Store the document ID for removal
                        });
                    }
                });
                renderUserSchedule(currentSchedule);
            }, (error) => {
                console.error("Schedule listener error:", error);
                displayMessage('Failed to fetch schedule in real-time.', 'error');
            });
        }

        // --- Event Listeners and Initial Load ---

        window.onload = async () => {
            // Load CSV data first
            allCourses = await fetchCourseData();
            renderAvailableCourses(allCourses, '');

            // Setup Search Input
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', (e) => {
                renderAvailableCourses(allCourses, e.target.value);
            });
            
            // Initialize Firebase services
            await initializeFirebase();
        };

    </script>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        
        <!-- User Info and Messages -->
        <div class="mb-4 flex justify-between items-center px-4 sm:px-0">
            <div class="text-sm text-gray-500">
                User ID: <span id="user-id-display" class="font-mono text-gray-700 bg-gray-200 px-2 py-0.5 rounded-md">Loading...</span>
            </div>
        </div>

        <!-- Message Box -->
        <div id="message-box" class="opacity-0 transition-opacity duration-300 px-4 sm:px-0" role="alert"></div>
        <div id="error-message" class="text-center text-red-600 font-medium mb-4"></div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Column: Course Selector -->
            <div class="lg:col-span-2 bg-white rounded-xl shadow-2xl overflow-hidden">
                <div class="p-6">
                    <h2 class="text-2xl font-extrabold text-gray-900 mb-4 border-b pb-2">
                        Available Course Offerings
                    </h2>
                    
                    <input type="text" id="search-input" placeholder="Search by Code, Title, or Faculty Initial (e.g., CSE 4303, ML, AHMOH)"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4 transition duration-150">

                    <div id="available-courses-list" class="max-h-[65vh] overflow-y-auto border border-gray-200 rounded-lg">
                        <!-- Courses will be dynamically inserted here -->
                        <div class="p-4 text-center text-gray-500">Loading course data...</div>
                    </div>
                </div>
            </div>

            <!-- Right Column: User Schedule -->
            <div class="lg:col-span-1 bg-indigo-50 rounded-xl shadow-2xl overflow-hidden">
                <div class="p-6">
                    <h2 class="text-2xl font-extrabold text-indigo-900 mb-4 border-b border-indigo-200 pb-2">
                        Your Current Schedule
                    </h2>
                    
                    <div class="flex justify-between items-center mb-4 p-3 bg-indigo-200 rounded-lg font-semibold text-indigo-900 shadow-inner">
                        <span>Total Credits:</span>
                        <span id="total-credits" class="text-2xl font-extrabold">0</span>
                    </div>

                    <div id="user-schedule-list" class="max-h-[55vh] overflow-y-auto pr-2">
                        <!-- Selected courses will be dynamically inserted here -->
                        <p class="text-gray-500 p-4 text-center">Your schedule is loading...</p>
                    </div>
                    
                    <div class="mt-6 p-4 bg-indigo-100 rounded-lg text-sm text-indigo-800">
                        <p class="font-medium mb-1">Conflict Detection:</p>
                        <p>The scheduler automatically checks for time overlaps on the same day when you try to add a new course.</p>
                    </div>

                </div>
            </div>

        </div>
    </div>
</body>
</html>
