<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University Course Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for better look */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #93c5fd; /* Tailwind blue-300 */
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background-color: #f7fafc; /* Tailwind gray-50 */
        }
        
        .section-card {
            transition: all 0.2s ease;
            cursor: pointer;
            border: 2px solid transparent; /* Ensure space for border */
        }
        .section-card:not(.selected):not(.conflict):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border-color: #a5b4fc; /* Tailwind indigo-300 on hover */
        }
        .conflict {
            border-color: #f87171 !important; /* Tailwind red-400 */
            background-color: #fee2e2 !important; /* Tailwind red-100 */
            animation: pulse-red 1s infinite alternate;
        }
        @keyframes pulse-red {
            from { box-shadow: 0 0 0 0 rgba(248, 113, 113, 0.7); }
            to { box-shadow: 0 0 0 6px rgba(248, 113, 113, 0); }
        }
        .selected {
            border-color: #34d399 !important; /* Tailwind emerald-400 */
            background-color: #d1fae5 !important; /* Tailwind emerald-100 */
            position: relative;
        }
        .selected::after {
            content: 'âœ“';
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 1.5rem;
            color: #065f46; /* Tailwind green-800 */
        }
        .course-selected {
            background-color: #e0f2fe !important; /* Tailwind sky-100 */
            border-color: #38bdf8 !important; /* Tailwind sky-400 */
        }
        
        /* Responsive adjustments for course selection view */
        @media (max-width: 1023px) {
            #assignment-course-list {
                max-height: 200px;
                flex-wrap: wrap;
                overflow-y: auto;
                overflow-x: hidden;
                gap: 0.75rem;
                padding-bottom: 0;
            }
            .course-item-card {
                width: calc(50% - 0.75rem);
                flex-shrink: 0;
            }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <script type="module">
        // --- Global State Management ---
        
        // Data derived from CSV
        let allCoursesData = []; 
        let uniqueCourses = {}; // {courseKey: [section1, section2, ...]}

        // Application State
        let selectedCoursesForAssignment = new Set(); // Keys of courses user wants to schedule (View 1)
        let selectedSections = {}; // {courseKey: sectionData} - The actual schedule (View 2)

        let viewState = 'courseSelection'; // 'courseSelection' or 'sectionAssignment'
        let currentView2CourseKey = null; // Key of the course currently displayed in the Section list panel
        
        const LOCAL_STORAGE_KEY = 'courseSchedulerStateV1';

        // --- Data Persistence (using localStorage) ---

        /**
         * Loads state from localStorage or initializes default state.
         */
        function loadStateFromLocalStorage() {
            const storedState = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedState) {
                const state = JSON.parse(storedState);
                
                // Restore Sets and Objects correctly
                selectedCoursesForAssignment = new Set(state.selectedCoursesForAssignment || []);
                selectedSections = state.selectedSections || {};
                viewState = state.viewState || 'courseSelection';
                currentView2CourseKey = state.currentView2CourseKey || null;
                
                displayMessage('Schedule loaded from local storage.', 'info');
            } else {
                displayMessage('Starting new schedule.', 'info');
            }
        }

        /**
         * Saves current application state to localStorage.
         */
        function saveStateToLocalStorage() {
            const stateToSave = {
                selectedCoursesForAssignment: Array.from(selectedCoursesForAssignment),
                selectedSections: selectedSections,
                viewState: viewState,
                currentView2CourseKey: currentView2CourseKey
            };
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(stateToSave));
        }


        // --- Utility Functions ---

        /**
         * Converts time string (e.g., '08:30:AM') to minutes from midnight.
         * @param {string} timeStr - The time string.
         * @returns {number} Minutes from midnight.
         */
        function timeToMinutes(timeStr) {
            if (!timeStr || timeStr.trim() === ' - ') return -1;
            // Handle time format like "HH:MM:PERIOD"
            const parts = timeStr.trim().match(/(\d{1,2}):(\d{2}):(AM|PM)/);
            if (!parts) return -1; 

            let [, hoursStr, minutesStr, period] = parts;
            let hours = parseInt(hoursStr, 10);
            let minutes = parseInt(minutesStr, 10);

            if (period === 'PM' && hours !== 12) {
                hours += 12;
            } else if (period === 'AM' && hours === 12) {
                hours = 0; // Midnight (12:xx AM) is 0 hours
            }
            return hours * 60 + minutes;
        }

        /**
         * Checks for time conflicts between the new course and the currently selected courses.
         * @param {object} newCourse - The section object to check.
         * @returns {string | null} Conflict message or null if no conflict.
         */
        const checkConflict = (newCourse) => {
            const allScheduledSections = Object.values(selectedSections);

            // Get the time slots for the new course
            const newTimes = [];
            if (newCourse.Day1 && newCourse.Time1 && newCourse.Time1.trim() !== ' - ') {
                const [start, end] = newCourse.Time1.split(' - ').map(t => timeToMinutes(t));
                newTimes.push({ day: newCourse.Day1, start, end, section: newCourse.Section });
            }
            if (newCourse.Day2 && newCourse.Time2 && newCourse.Time2.trim() !== ' - ') {
                const [start, end] = newCourse.Time2.split(' - ').map(t => timeToMinutes(t));
                newTimes.push({ day: newCourse.Day2, start, end, section: newCourse.Section });
            }

            for (const existingCourse of allScheduledSections) {
                // Ignore conflicts with itself when checking an existing selection for visual feedback
                if (existingCourse.id === newCourse.id) continue;

                const existingTimes = [];
                if (existingCourse.Day1 && existingCourse.Time1 && existingCourse.Time1.trim() !== ' - ') {
                    const [start, end] = existingCourse.Time1.split(' - ').map(t => timeToMinutes(t));
                    existingTimes.push({ day: existingCourse.Day1, start, end });
                }
                if (existingCourse.Day2 && existingCourse.Time2 && existingCourse.Time2.trim() !== ' - ') {
                    const [start, end] = existingCourse.Time2.split(' - ').map(t => timeToMinutes(t));
                    existingTimes.push({ day: existingCourse.Day2, start, end });
                }

                for (const newTime of newTimes) {
                    for (const existingTime of existingTimes) {
                        if (newTime.day === existingTime.day) {
                            // Check for overlap: (StartA < EndB) and (EndA > StartB)
                            if (newTime.start < existingTime.end && newTime.end > existingTime.start) {
                                return `Conflict: ${newCourse.FormalCode} conflicts with ${existingCourse.FormalCode} on ${newTime.day}.`;
                            }
                        }
                    }
                }
            }

            return null; // No conflict
        };

        // --- Data Loading and Processing ---

        async function fetchCourseData() {
            try {
                // Assuming 'course_offerings.csv' is available in the environment
                const filename = 'course_offerings.csv';
                const response = await fetch(filename);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const csvText = await response.text();
                const lines = csvText.trim().split('\r\n');
                
                // Simple CSV parsing: split by comma, trim, handle case where headers are not uniform
                const headers = lines[0].split(',').map(h => h.trim().replace('.', ''));
                
                const courses = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim());
                    if (values.length !== headers.length) continue; 
                    
                    const course = {};
                    headers.forEach((header, index) => {
                        let value = values[index];
                        if ((header === 'Time1' || header === 'Time2') && value === '') {
                            value = ' - ';
                        }
                        course[header] = value;
                    });
                    // Create a unique ID for each section
                    course.id = `${course.FormalCode}-${course.Section}`;
                    courses.push(course);
                }

                allCoursesData = courses;
                processCourseData();
            } catch (error) {
                console.error("Failed to fetch or parse CSV data:", error);
                displayMessage('Error loading course data. Check console for details.', 'error');
            }
        }

        function processCourseData() {
            uniqueCourses = {};
            
            allCoursesData.forEach(course => {
                const courseKey = `${course.FormalCode} - ${course.Title}`;
                if (!uniqueCourses[courseKey]) {
                    uniqueCourses[courseKey] = [];
                }
                uniqueCourses[courseKey].push(course);
            });
            // Sort sections by section name for better UX
            Object.keys(uniqueCourses).forEach(key => {
                uniqueCourses[key].sort((a, b) => a.Section.localeCompare(b.Section));
            });
        }

        // --- State Manipulation Functions ---

        /**
         * Toggles a course's inclusion in the scheduling process (View 1 logic).
         */
        function toggleCourseSelection(courseKey) {
            if (selectedCoursesForAssignment.has(courseKey)) {
                selectedCoursesForAssignment.delete(courseKey);
                // Also ensure any assigned section for this course is removed from the schedule
                if (selectedSections[courseKey]) {
                    delete selectedSections[courseKey];
                    displayMessage(`Removed ${courseKey} and its section from the schedule.`, 'warning');
                }
            } else {
                selectedCoursesForAssignment.add(courseKey);
                displayMessage(`Selected ${courseKey} for scheduling.`, 'info');
            }
            saveStateToLocalStorage();
            renderApp();
        }

        /**
         * Selects or deselects a specific section for a course (View 2 logic).
         */
        function updateSectionSelection(courseKey, sectionData) {
            const currentSelectedSection = selectedSections[courseKey];

            if (currentSelectedSection && currentSelectedSection.id === sectionData.id) {
                // Case 1: Deselecting the currently selected section
                delete selectedSections[courseKey];
                displayMessage(`Deselected section ${sectionData.Section} for ${sectionData.FormalCode}.`, 'warning');

            } else {
                // Case 2: Selecting a new section (check for conflicts)
                const conflict = checkConflict(sectionData);
                if (conflict) {
                    displayMessage(conflict, 'error');
                    return;
                }
                
                // Case 3: Update/set the new section
                selectedSections[courseKey] = sectionData;
                displayMessage(`Selected section ${sectionData.Section} for ${sectionData.FormalCode}.`, 'success');
            }
            
            saveStateToLocalStorage();
            renderApp(); // Rerender both the course list (View 1) and section details (View 2)
        }

        // --- UI Rendering ---

        /**
         * The main render function, determines which view to show.
         */
        function renderApp() {
            const container = document.getElementById('app-container');
            if (allCoursesData.length === 0) return; // Wait for data

            container.innerHTML = `
                ${renderScheduleSummary()}
                ${viewState === 'courseSelection' ? renderCourseSelectionView1() : renderSectionAssignmentView2()}
            `;
            attachEventListeners();
        }

        function renderScheduleSummary() {
            const totalCredits = Object.values(selectedSections).reduce((sum, course) => sum + (parseFloat(course.Cr) || 0), 0);
            const scheduledCourses = Object.values(selectedSections).length;

            let summaryHtml = '<div class="flex flex-wrap gap-4 mb-6 p-4 bg-white rounded-xl shadow-lg border-t-4 border-indigo-500">';
            
            // Credits Card
            summaryHtml += `
                <div class="flex-1 min-w-[150px] p-4 bg-indigo-50 rounded-lg">
                    <div class="text-sm font-medium text-indigo-600">Total Credits</div>
                    <div class="text-3xl font-extrabold text-indigo-900">${totalCredits.toFixed(0)}</div>
                </div>
            `;
            // Scheduled Courses Card
            summaryHtml += `
                <div class="flex-1 min-w-[150px] p-4 bg-emerald-50 rounded-lg">
                    <div class="text-sm font-medium text-emerald-600">Scheduled Courses</div>
                    <div class="text-3xl font-extrabold text-emerald-900">${scheduledCourses}</div>
                </div>
            `;
            // View Toggle Button
            const isSelectionView = viewState === 'courseSelection';
            summaryHtml += `
                <div class="flex-1 min-w-[150px] flex items-center justify-center p-4">
                    <button id="toggle-view-button" data-view="${isSelectionView ? 'sectionAssignment' : 'courseSelection'}"
                            class="w-full py-3 px-4 rounded-xl font-semibold text-white transition duration-200 shadow-md ${isSelectionView ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-emerald-600 hover:bg-emerald-700'}">
                        ${isSelectionView ? 'Go to Section Assignment' : 'Back to Course Selection'}
                    </button>
                </div>
            `;
            
            summaryHtml += '</div>';
            return summaryHtml;
        }

        /**
         * Renders the initial course selection view (View 1).
         */
        function renderCourseSelectionView1() {
            const courseKeys = Object.keys(uniqueCourses).sort();
            let html = `
                <div class="bg-white rounded-xl shadow-2xl p-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4 border-b pb-2">Step 1: Select Courses to Schedule</h2>
                    <p class="text-gray-600 mb-4">Click any course to toggle whether you want to include it in your schedule.</p>
                    <div id="course-list-container" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 custom-scroll max-h-[70vh] overflow-y-auto pr-2">
            `;

            courseKeys.forEach(courseKey => {
                const sections = uniqueCourses[courseKey];
                const isSelected = selectedCoursesForAssignment.has(courseKey);
                const firstSection = sections[0]; // Use first section for basic info
                
                html += `
                    <div data-course-key="${courseKey}" 
                         class="course-select-card course-item-card p-4 rounded-xl border-2 cursor-pointer transition-all duration-150 ${isSelected ? 'course-selected border-sky-400 shadow-md' : 'bg-gray-50 border-gray-200 hover:bg-gray-100'}"
                         >
                        <div class="font-bold text-lg">${firstSection.FormalCode}</div>
                        <div class="text-sm text-gray-600 truncate mb-2" title="${firstSection.Title}">${firstSection.Title}</div>
                        <div class="text-xs text-gray-500">${sections.length} sections</div>
                        <div class="text-xs font-semibold ${isSelected ? 'text-sky-700' : 'text-gray-400'} mt-1">
                            ${isSelected ? 'Selected' : 'Click to Select'}
                        </div>
                    </div>
                `;
            });

            html += `</div></div>`;
            return html;
        }

        /**
         * Renders the section assignment and schedule review view (View 2).
         */
        function renderSectionAssignmentView2() {
            const courseKeys = Array.from(selectedCoursesForAssignment).sort();
            
            if (courseKeys.length > 0 && !currentView2CourseKey) {
                currentView2CourseKey = courseKeys[0];
            } else if (courseKeys.length === 0) {
                currentView2CourseKey = null; // Clear if no courses selected
                return `
                    <div class="bg-white rounded-xl shadow-2xl p-6 text-center text-xl text-gray-600">
                        <p class="mb-4">No courses selected for scheduling.</p>
                        <p>Please go back to "Course Selection" to pick courses first.</p>
                    </div>
                `;
            }

            const activeSections = uniqueCourses[currentView2CourseKey] || [];
            const activeCourseData = activeSections[0] || {};
            
            let html = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- Left Panel: Assigned Courses List -->
                    <div class="lg:col-span-1 bg-gray-50 rounded-xl shadow-xl p-4">
                        <h3 class="text-xl font-bold text-gray-800 mb-3 border-b pb-2">Assigned Courses (${courseKeys.length})</h3>
                        <div id="assignment-course-list" class="flex flex-col gap-2 custom-scroll max-h-[60vh] overflow-y-auto">
            `;
            
            // Render selected courses for quick switching
            courseKeys.forEach(courseKey => {
                const courseInfo = uniqueCourses[courseKey][0];
                const isCurrent = courseKey === currentView2CourseKey;
                const selectedSection = selectedSections[courseKey];
                const statusClass = selectedSection ? 'border-emerald-500 bg-emerald-50' : 'border-indigo-200 bg-white';
                
                html += `
                    <div data-course-key="${courseKey}"
                         class="switch-course-card p-3 rounded-lg border-2 cursor-pointer transition duration-150 ${statusClass} ${isCurrent ? 'ring-4 ring-indigo-300 shadow-md' : 'hover:bg-indigo-100'}"
                    >
                        <div class="font-semibold text-gray-900">${courseInfo.FormalCode}</div>
                        <div class="text-xs text-gray-600 truncate">${courseInfo.Title}</div>
                        <div class="text-xs ${selectedSection ? 'text-emerald-700 font-bold' : 'text-red-500'} mt-1">
                            ${selectedSection ? `Section: ${selectedSection.Section}` : 'Needs Section'}
                        </div>
                    </div>
                `;
            });

            html += `</div></div>`; // Close Left Panel

            // Right Panel: Sections for Active Course
            html += `
                <div class="lg:col-span-2 bg-white rounded-xl shadow-2xl p-6">
                    <h3 class="text-2xl font-extrabold text-indigo-900 mb-4 border-b pb-2">
                        Sections for: ${activeCourseData.FormalCode || 'N/A'} - ${activeCourseData.Title || 'Select a Course'}
                    </h3>
                    <div class="text-sm text-gray-600 mb-4">Select a section below to add or update your schedule. Click again to remove.</div>

                    <div id="sections-detail-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 custom-scroll max-h-[55vh] overflow-y-auto pr-2">
            `;

            // Render all sections for the active course
            activeSections.forEach(section => {
                const courseKey = `${section.FormalCode} - ${section.Title}`;
                const isSelected = selectedSections[courseKey] && selectedSections[courseKey].id === section.id;
                const conflict = checkConflict(section);
                
                let cardClass = 'bg-white border-gray-200 shadow';
                if (conflict && !isSelected) {
                    cardClass = 'conflict shadow-lg';
                } else if (isSelected) {
                    cardClass = 'selected shadow-lg';
                } else if (conflict && isSelected) {
                     // If it's the selected course, but it now conflicts with a newly selected section in another course
                    cardClass = 'selected conflict shadow-lg';
                }

                let timeInfo = `<span class="font-medium">${section.Day1}:</span> ${section.Time1}`;
                if (section.Day2 && section.Day2.trim() !== ' - ' && section.Day2.trim() !== section.Day1.trim()) {
                    timeInfo += `<br><span class="font-medium">${section.Day2}:</span> ${section.Time2}`;
                }

                // Pass the section data as a JSON string
                const sectionDataJson = JSON.stringify(section).replace(/'/g, '&apos;');

                html += `
                    <div data-section-id="${section.id}" 
                         data-course-key="${courseKey}"
                         class="section-card p-4 rounded-xl border-2 transition-all duration-300 ${cardClass}"
                         data-section-data='${sectionDataJson}'
                    >
                        <div class="flex justify-between items-center mb-2">
                            <div class="text-xl font-bold text-gray-900">Section ${section.Section}</div>
                            <div class="text-sm font-semibold text-indigo-600">${section.Cr} Cr</div>
                        </div>
                        <div class="text-sm text-gray-700 leading-snug">${timeInfo}</div>
                        <div class="text-xs text-gray-500 mt-1">Instructor: ${section.Initial} (${section['Faculty Full Name']})</div>
                        <div class="text-xs text-gray-500">Room: ${section.Room1} ${section.Room2.trim() !== '' && section.Room2.trim() !== section.Room1.trim() ? `| ${section.Room2}` : ''}</div>
                        ${conflict && !isSelected ? `<p class="text-xs font-bold text-red-700 mt-2">CONFLICT with an existing course!</p>` : ''}
                    </div>
                `;
            });

            html += `</div></div></div>`; // Close Right Panel and Grid
            return html;
        }
        
        // --- Event Handlers and Listeners ---

        function attachEventListeners() {
            // 1. View Toggle Button
            document.getElementById('toggle-view-button')?.addEventListener('click', (e) => {
                const targetView = e.currentTarget.dataset.view;
                viewState = targetView;
                saveStateToLocalStorage();
                renderApp();
            });

            // 2. Course Selection (View 1)
            document.querySelectorAll('.course-select-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const courseKey = e.currentTarget.dataset.courseKey;
                    toggleCourseSelection(courseKey);
                });
            });

            // 3. Section Assignment (View 2 - Right Panel)
            document.querySelectorAll('.section-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const sectionData = JSON.parse(e.currentTarget.dataset.sectionData.replace(/&apos;/g, "'"));
                    const courseKey = e.currentTarget.dataset.courseKey;
                    updateSectionSelection(courseKey, sectionData);
                });
            });

            // 4. Course Switch (View 2 - Left Panel)
            document.querySelectorAll('.switch-course-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const courseKey = e.currentTarget.dataset.courseKey;
                    currentView2CourseKey = courseKey;
                    saveStateToLocalStorage();
                    renderApp(); // Rerender to show new section details
                });
            });
        }
        
        // --- Message Box ---

        function displayMessage(message, type) {
            const messageBox = document.getElementById('message-box');
            // Remove existing classes
            messageBox.className = "opacity-0 transition-opacity duration-300 w-full md:w-auto";
            messageBox.textContent = message;
            
            const baseClass = 'p-3 rounded-lg text-white font-medium mb-4';
            const typeClass = type === 'success' ? 'bg-emerald-500' : (type === 'error' ? 'bg-red-500' : 'bg-blue-500');

            // Apply classes and make it visible
            setTimeout(() => {
                messageBox.className = `${baseClass} ${typeClass} opacity-100 transition-opacity duration-300 w-full md:w-auto`;
            }, 10); // Small delay to reset transition

            // Hide after 4 seconds
            setTimeout(() => {
                messageBox.className = messageBox.className.replace('opacity-100', 'opacity-0');
            }, 4000);
        }

        // --- Initial Load ---

        window.onload = async () => {
            // 1. Fetch and process course data
            await fetchCourseData();
            
            // 2. Load previous state
            loadStateFromLocalStorage();

            // 3. Remove loading indicator and render the app
            document.getElementById('loading-indicator').style.display = 'none';
            renderApp();
        };

    </script>
</head>
<body class="bg-gray-50 min-h-screen font-sans antialiased p-4 sm:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">University Course Scheduler</h1>
            <p class="text-gray-600">Plan your semester schedule with ease and conflict detection.</p>
        </header>
        
        <!-- User Info and Messages -->
        <div class="mb-4 flex flex-col md:flex-row justify-end items-start md:items-center">
            <!-- Message Box -->
            <div id="message-box" class="opacity-0 transition-opacity duration-300 w-full md:w-auto" role="alert"></div>
        </div>

        <!-- Dynamic View Container -->
        <div id="app-container">
            <!-- Loading indicator initially, then content -->
            <div id="loading-indicator" class="text-center py-20">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                <p class="text-gray-700 font-semibold">Loading course data from course_offerings.csv...</p>
            </div>
        </div>
    </div>
</body>
</html>
